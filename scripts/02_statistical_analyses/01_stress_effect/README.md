# Analysis Pipeline: Stress Effects on Voice (Main Effects Only)

**Purpose:** Examine how exam stress alters vocal F0 and NNE using hierarchical Bayesian models.

**Key Question:** Does acute stress change fundamental frequency and glottal noise?

---

## Quick Start

### Prerequisites
```r
install.packages(c("tidyverse", "rstan", "bayesplot", "loo", "posterior", "gt", "here", "glue"))
```

### Run Analysis (Execute in Order)
```bash
# 1. Fit models (10-30 min runtime)
Rscript 01_main_effects_analysis.R

# 2. Generate tables/figures
Rscript 02_manuscript_tables_figures.R

# 3. Auto-populate Results section
Rscript 05_populate_results.R

# 4. Quality control diagnostics
Rscript 06_diagnostic_report.R
```

---

## Model Specification

### Data Structure Required
```
subj_id  timepoint   f0_mean   nne
1        BASELINE    215.3     -26.8
1        PRE         223.1     -28.4
1        POST        220.5     -27.9
...
```

### Orthogonal Contrasts
- **c1 (Stress):** PRE vs BASELINE ‚Üí Œ≤‚ÇÅ captures stress-induced change
- **c2 (Recovery):** POST vs PRE ‚Üí Œ≤‚ÇÇ captures recovery/persistence

| Timepoint | c1    | c2    |
|-----------|-------|-------|
| BASELINE  | -0.5  | 0.0   |
| PRE       | +0.5  | -0.5  |
| POST      | 0.0   | +0.5  |

### Hierarchical Structure
```
Level 1: y_ij = Œ± + Œ≤‚ÇÅ¬∑c1 + Œ≤‚ÇÇ¬∑c2 + u‚ÇÄ·µ¢ + u‚ÇÅ·µ¢¬∑c1 + u‚ÇÇ·µ¢¬∑c2 + Œµ·µ¢‚±º
Level 2: [u‚ÇÄ, u‚ÇÅ, u‚ÇÇ] ~ MVN(0, Œ£)
```

Random effects allow individual differences in:
- Baseline vocal parameters (u‚ÇÄ)
- Stress reactivity (u‚ÇÅ)
- Recovery dynamics (u‚ÇÇ)

---

## Quality Control Checklist

### ‚úÖ **STEP 1: Verify Model Convergence**
**Check:** `results/diagnostic_report.txt`

```
Required:
‚ñ° R-hat < 1.01 for all parameters
‚ñ° ESS > 400 for all parameters  
‚ñ° Divergent transitions = 0
‚ñ° Pareto k < 0.7 (LOO diagnostic)
```

**If any fail** ‚Üí See Troubleshooting below

---

### üìä **STEP 2: Extract Results for Manuscript**

#### Main Results File (Ready to Use)
```
manuscript/results_main_effects_complete.md
```
- **What it contains:** Complete Results section with all numerical values populated
- **How to use:** Copy/paste directly into your manuscript
- **Auto-generated by:** `05_populate_results.R`

#### Quick Reference Table
```
manuscript/parameter_estimates_summary.csv
```

Example output:
```
Parameter          | Median | 95% CI           | P(direction)
F0: Stress (Œ≤‚ÇÅ)    | 3.27   | [0.81, 5.71]    | 0.995
F0: Recovery (Œ≤‚ÇÇ)  | 0.14   | [-2.34, 2.59]   | 0.542
NNE: Stress (Œ≤‚ÇÅ)   | -0.65  | [-1.20, -0.11]  | 0.990
NNE: Recovery (Œ≤‚ÇÇ) | -0.22  | [-0.77, 0.33]   | 0.781
```

**Interpretation:**
- P(direction) > 0.95 ‚Üí Strong evidence
- P(direction) 0.80-0.95 ‚Üí Moderate evidence
- P(direction) < 0.80 ‚Üí Weak/ambiguous

---

### üìà **STEP 3: Publication Materials**

#### Table for Main Text
```
results/stress/tables/table1_main_effects.docx  (insert in Word)
results/stress/tables/table1_main_effects.html  (preview/web)
```

#### Figures for Main Text
```
results/stress/figures/figure1_posterior_distributions.png
results/stress/figures/figure2_trajectories.png
results/stress/figures/figure3_effect_sizes.png
```

#### Supplementary Diagnostics
```
figures/diagnostic_trace_f0.png      (MCMC convergence)
figures/diagnostic_acf_f0.png        (Autocorrelation)
results/stress/figures/f0_ppc.png    (Posterior predictive checks)
```

---

### üîç **STEP 4: Advanced Verification (Optional)**

If you need to verify specific calculations:

**Full posterior samples:**
```
results/stress/models/f0_posterior_samples.csv   (16,000 draws √ó parameters)
results/stress/models/nne_posterior_samples.csv
```

**Descriptive statistics:**
```
results/stress/descriptive_statistics.csv
```

Example:
```r
library(tidyverse)

# Load posterior
post_f0 <- read_csv("results/stress/models/f0_posterior_samples.csv")

# Custom calculation
median(post_f0$b1)                    # Stress effect median
quantile(post_f0$b1, c(0.025, 0.975)) # 95% CI
mean(post_f0$b1 > 0)                  # P(Œ≤‚ÇÅ > 0)

# Effect size relative to baseline variability
post_f0 %>%
  summarise(
    stress_effect = median(b1),
    baseline_sd = median(`tau[1]`),
    cohen_d = stress_effect / baseline_sd
  )
```

---

## Expected Results

### F0 Mean (Fundamental Frequency)
- **Stress effect (Œ≤‚ÇÅ):** Positive (~3-8 Hz increase)
  - **Interpretation:** Pitch elevation due to laryngeal tension and arousal
  - **P(Œ≤‚ÇÅ > 0) > 0.95** ‚Üí Strong evidence
  
- **Recovery effect (Œ≤‚ÇÇ):** Variable (may persist, plateau, or normalize)
  - **Œ≤‚ÇÇ ‚âà 0:** Stress-induced elevation persists post-exam
  - **Œ≤‚ÇÇ < 0:** Partial recovery toward baseline
  - **Œ≤‚ÇÇ > 0:** Continued elevation

### NNE (Normalized Noise Energy)
- **Stress effect (Œ≤‚ÇÅ):** Negative (~0.5-1.5 dB decrease)
  - **Interpretation:** Reduced glottal noise = more periodic signal (pressed voice)
  - **P(Œ≤‚ÇÅ < 0) > 0.95** ‚Üí Strong evidence
  
- **Recovery effect (Œ≤‚ÇÇ):** Variable (similar patterns to F0)

### Dual-Process Interpretation
- **F0 ‚Üë:** Arousal-driven (sympathetic activation)
- **NNE ‚Üì:** Control-driven (compensatory phonatory adjustment)
- **Dissociation:** Supports multiple independent mechanisms

---

## Troubleshooting

### Convergence Problems (R-hat > 1.01)

**Solution 1:** Increase adapt_delta
```r
# In 01_main_effects_analysis.R, line ~212
adapt_delta = 0.99  # increase from 0.95
```

**Solution 2:** More iterations
```r
iter_warmup = 3000,    # increase from 2000
iter_sampling = 6000,  # increase from 4000
```

**Solution 3:** Check data
```r
# Look for outliers
df_voice %>%
  group_by(timepoint) %>%
  summarise(across(c(y_f0, y_nne), 
                   list(min = min, max = max, mean = mean, sd = sd)))
```

### Divergent Transitions > 0

This usually indicates:
1. **Model misspecification** (unlikely with these simple models)
2. **Extreme parameter values** (check priors are reasonable)
3. **Numerical issues** (try stronger priors on œÑ)

**Fix:**
```r
# In .stan files, line ~45-46
tau ~ exponential(1.0);  # stronger prior (faster decay)
```

### Memory Issues

**Solution:** Thin posterior samples
```r
# In 05_populate_results.R, after loading
post_f0 <- post_f0 %>% slice_sample(n = 4000)  # reduce from 16,000
```

---

## File Paths Reference

### Input
```
data/raw/acustic_features/datiacustici/AUDIO.xlsx
```

### Stan Models
```
stan/stress/f0_main_effects.stan
stan/stress/nne_main_effects.stan
```

### Outputs (Generated)
```
results/stress/
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ fit_f0_main_effects.rds          # Fitted model objects
‚îÇ   ‚îú‚îÄ‚îÄ fit_nne_main_effects.rds
‚îÇ   ‚îú‚îÄ‚îÄ f0_posterior_samples.csv         # Full posterior (16k draws)
‚îÇ   ‚îî‚îÄ‚îÄ nne_posterior_samples.csv
‚îú‚îÄ‚îÄ figures/
‚îÇ   ‚îú‚îÄ‚îÄ figure1_posterior_distributions.png
‚îÇ   ‚îú‚îÄ‚îÄ figure2_trajectories.png
‚îÇ   ‚îú‚îÄ‚îÄ figure3_effect_sizes.png
‚îÇ   ‚îú‚îÄ‚îÄ f0_ppc.png
‚îÇ   ‚îî‚îÄ‚îÄ nne_ppc.png
‚îú‚îÄ‚îÄ tables/
‚îÇ   ‚îú‚îÄ‚îÄ table1_main_effects.html
‚îÇ   ‚îî‚îÄ‚îÄ table1_main_effects.docx
‚îî‚îÄ‚îÄ descriptive_statistics.csv

manuscript/
‚îú‚îÄ‚îÄ results_main_effects_complete.md     # ‚Üê COPY THIS TO MANUSCRIPT
‚îî‚îÄ‚îÄ parameter_estimates_summary.csv      # Quick reference

results/
‚îî‚îÄ‚îÄ diagnostic_report.txt                # ‚Üê CHECK THIS FIRST
```

---

## Parameter Interpretation Guide

### Fixed Effects
- **Œ± (alpha):** Grand mean at BASELINE (after accounting for contrasts)
- **Œ≤‚ÇÅ (b1):** Average change PRE ‚Üí BASELINE (stress effect)
- **Œ≤‚ÇÇ (b2):** Average change POST ‚Üí PRE (recovery effect)

### Random Effects
- **œÑ‚ÇÅ (tau[1]):** SD of individual baselines
- **œÑ‚ÇÇ (tau[2]):** SD of individual stress effects (reactivity heterogeneity)
- **œÑ‚ÇÉ (tau[3]):** SD of individual recovery effects
- **œÉ (sigma_y):** Residual SD (within-person noise)

### Variance Partitioning
```r
# Intraclass correlation (baseline)
ICC = œÑ‚ÇÅ¬≤ / (œÑ‚ÇÅ¬≤ + œÉ¬≤)

# Proportion of stress variance between-person
R¬≤ = œÑ‚ÇÇ¬≤ / (œÑ‚ÇÇ¬≤ + œÉ¬≤)
```

---

## Effect Size Benchmarks

### F0 Mean (Hz)
- **Small:** 3-5 Hz
- **Medium:** 5-10 Hz
- **Large:** >10 Hz

**Context:** Just-noticeable difference ~1-2 Hz; clinical significance ~5 Hz

### NNE (dB)
- **Small:** 0.5-1.5 dB
- **Medium:** 1.5-3 dB
- **Large:** >3 dB

**Context:** NNE typically ranges -15 to -30 dB; 1 dB change is perceptible

---

## Citation

If you use this pipeline, please cite:

```bibtex
@article{yourname2025stress,
  title={Acoustic signatures of exam stress: A hierarchical Bayesian analysis},
  author={Your Name and Collaborators},
  journal={Journal Name},
  year={2025},
  note={Analysis code: https://github.com/yourrepo}
}
```

---

## Questions?

**Common issues:**
- Model won't converge ‚Üí See Troubleshooting section
- Results look weird ‚Üí Check `results/diagnostic_report.txt` first
- Path errors ‚Üí Verify working directory with `here::here()`
- Missing packages ‚Üí Run Prerequisites section

**For additional support:**
- GitHub Issues: [repository link]
- Email: [your email]

---

## Version

- **v1.0** (2025-01): Initial release
- **Analysis date:** Check timestamp in `diagnostic_report.txt`
